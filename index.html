<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Okinawa Journey | æ²–ç¹©äº”æ—¥éŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;600;700&family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      body {
        font-family: 'Zen Maru Gothic', sans-serif;
        background-color: #FEFCE8; /* Rice Yellow */
        color: #57534E; /* Stone 600 */
        background-image: radial-gradient(#E5E0D8 1px, transparent 1px);
        background-size: 20px 20px;
        -webkit-tap-highlight-color: transparent;
      }
      h1, h2, h3, h4, .serif {
        font-family: 'Shippori Mincho', serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #D6D3D1; 
        border-radius: 3px;
      }
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
      /* Utilities */
      .hidden { display: none !important; }
      .fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.32.0",
    "react-markdown": "https://aistudiocdn.com/react-markdown@^10.1.0"
  }
}
</script>
</head>
<body class="bg-[#FEFCE8] text-stone-800 overflow-x-hidden">

    <!-- Background Decorations -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden opacity-50">
        <!-- Hibiscus -->
        <svg class="absolute -right-8 top-10 w-40 h-40 text-rose-300 transform rotate-12" viewBox="0 0 100 100" fill="currentColor">
            <path d="M50 50 Q70 20 90 40 Q80 70 50 60 Q20 70 10 40 Q30 20 50 50 Z" opacity="0.6"/>
            <circle cx="50" cy="50" r="10" fill="#F43F5E"/>
            <path d="M50 50 L50 20 M50 50 L80 50 M50 50 L50 80 M50 50 L20 50" stroke="#F43F5E" strokeWidth="2"/>
        </svg>
        <!-- Whale Shark -->
        <svg class="absolute -left-10 top-1/3 w-64 h-64 text-blue-200 transform -rotate-12" viewBox="0 0 200 100" fill="currentColor">
            <path d="M20 50 Q60 20 120 40 Q160 50 180 40 L190 50 L180 60 Q160 50 120 60 Q60 80 20 50 Z" />
            <circle cx="40" cy="45" r="3" fill="#FFF"/>
            <circle cx="150" cy="50" r="2" fill="#FFF"/>
            <circle cx="130" cy="45" r="2" fill="#FFF"/>
            <circle cx="110" cy="55" r="2" fill="#FFF"/>
        </svg>
        <!-- Shisa -->
        <svg class="absolute -right-4 bottom-24 w-32 h-32 text-orange-200" viewBox="0 0 100 100" fill="currentColor">
            <path d="M20 80 L80 80 L90 60 Q95 40 70 30 Q50 20 30 30 Q5 40 10 60 Z" />
            <circle cx="35" cy="50" r="5" fill="#FFF"/>
            <circle cx="65" cy="50" r="5" fill="#FFF"/>
            <path d="M35 60 Q50 70 65 60" stroke="#FFF" strokeWidth="3" fill="none"/>
        </svg>
        <!-- Wave -->
        <svg class="absolute bottom-0 left-0 w-full h-20 text-teal-100/50" preserveAspectRatio="none" viewBox="0 0 1200 120">
            <path d="M0,0 C150,60 350,0 600,40 C850,80 1050,20 1200,60 L1200,120 L0,120 Z" fill="currentColor"/>
        </svg>
    </div>

    <!-- Main Container -->
    <div class="max-w-md mx-auto shadow-2xl overflow-hidden relative border-x-2 border-[#E7E5E4] min-h-screen flex flex-col bg-[#FEFCE8]">
        
        <!-- SCHEDULE TAB CONTENT -->
        <div id="view-schedule" class="pb-20 relative z-10">
            
            <!-- Header Image -->
            <div class="relative h-44 bg-stone-300 overflow-hidden rounded-b-[2rem] shadow-lg mb-2 group">
                <img id="header-img" src="https://image.pollinations.ai/prompt/beautiful%20okinawa%20beach%20turquoise%20ocean%20cinematic%20lighting?width=1080&height=600&nologo=true" class="w-full h-full object-cover opacity-90 transition-opacity duration-700" alt="Okinawa Header">
                <div class="absolute inset-0 bg-gradient-to-t from-stone-900/40 via-transparent to-transparent"></div>
                
                <!-- Magic Paint Button -->
                <button id="btn-generate-cover" class="absolute top-3 right-3 bg-white/30 backdrop-blur hover:bg-white/50 text-white p-2 rounded-full border border-white/50 shadow-sm transition-all active:scale-95">
                    <svg id="icon-paint" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                    <svg id="icon-loading" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>

                <div class="absolute bottom-4 left-6 text-white drop-shadow-md">
                    <h1 class="text-4xl font-bold serif tracking-wide">æ²–ç¹©äº”æ—¥</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-yellow-300 text-lg">â˜…</span>
                        <span class="text-sm font-medium tracking-wider">å®¶æ—ã®æ—…</span>
                    </div>
                </div>
            </div>

            <!-- Date Navigation -->
            <div class="sticky top-0 z-20 pt-2 pb-2">
                <div id="date-scroll" class="flex overflow-x-auto hide-scrollbar px-4 gap-3 snap-x">
                    <!-- Dates injected by JS -->
                </div>
            </div>

            <!-- Schedule Content -->
            <div class="px-4 py-4">
                <!-- Day Header -->
                <div class="mb-6 flex items-center justify-between bg-white/60 backdrop-blur rounded-full px-4 py-2 border border-white shadow-sm">
                    <h2 id="day-title" class="text-lg font-bold text-stone-700 serif">Loading...</h2>
                    <div class="flex items-center gap-1 text-sm font-medium text-stone-500 bg-stone-100/50 px-2 py-1 rounded-full">
                        <span id="day-weather-icon"></span>
                        <span id="day-weather-temp"></span>
                    </div>
                </div>

                <!-- Timeline Items -->
                <div id="timeline-container" class="space-y-6 relative">
                    <!-- Items injected by JS -->
                </div>
            </div>

            <!-- AI Assistant -->
            <div class="px-5 py-8 mt-4">
                <div class="bg-[#FFFBEB]/90 backdrop-blur rounded-3xl p-5 border-2 border-[#E7E5E4] shadow-lg relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-yellow-200 rounded-full opacity-50"></div>
                    <h3 class="serif text-lg font-bold text-stone-700 mb-4 flex items-center gap-2 relative z-10">
                        <span class="bg-stone-800 text-white rounded-lg p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
                        </span>
                        æ²–ç¹©å°å¹«æ‰‹
                    </h3>
                    
                    <div class="bg-white/80 rounded-2xl p-4 border border-stone-100 shadow-inner mb-4 relative z-10">
                        <div id="ai-response-area" class="hidden prose prose-stone prose-sm max-w-none mb-4">
                            <!-- AI Answer -->
                            <div id="ai-text-content"></div>
                            <div id="ai-sources" class="mt-2 flex flex-wrap gap-2"></div>
                            <button id="btn-reset-ai" class="text-xs text-amber-600 font-bold underline mt-3 block text-right">å•å…¶ä»–å•é¡Œ</button>
                        </div>
                        
                        <div id="ai-input-area" class="flex gap-2">
                            <input id="input-ai" type="text" placeholder="å•å•å¤©æ°£ã€æ¨è–¦ä¼´æ‰‹ç¦®..." class="flex-grow bg-[#FAFAF9] border border-stone-300 rounded-xl px-3 py-2 text-sm focus:border-stone-800 outline-none transition-colors">
                            <button id="btn-ask-ai" class="bg-yellow-400 hover:bg-yellow-500 text-stone-900 px-4 py-2 rounded-xl text-lg font-bold shadow-sm disabled:opacity-50 transition-colors">Go</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WALLET TAB CONTENT -->
        <div id="view-wallet" class="px-5 pb-24 pt-6 min-h-screen relative z-10 hidden">
             <!-- Header Card -->
            <div class="bg-[#FFFBEB]/90 backdrop-blur border-2 border-[#78716C] rounded-2xl p-5 mb-6 shadow-[4px_4px_0px_0px_rgba(120,113,108,1)] relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-sm font-bold text-stone-500 uppercase tracking-widest mb-1">ç¸½é–‹éŠ· Total</h2>
                    <div class="flex items-baseline gap-2">
                        <span id="total-spent" class="text-3xl font-black text-stone-800 tracking-tighter">Â¥0</span>
                        <span id="avg-spent" class="text-xs text-stone-500">(9äººå‡åˆ† Â¥0)</span>
                    </div>
                </div>
                <div class="absolute right-[-20px] top-[-20px] w-24 h-24 bg-yellow-200 rounded-full opacity-50 blur-xl"></div>
            </div>

            <!-- Add Button -->
            <button id="btn-show-form" class="w-full py-3 bg-[#4E342E] text-[#FEFCE8] rounded-xl font-bold shadow-lg active:scale-95 transition-all mb-8 flex items-center justify-center gap-2 border-2 border-transparent hover:bg-[#3E2723]">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
                è¨˜ä¸€ç­†
            </button>

            <!-- Add/Edit Form -->
            <div id="expense-form" class="hidden bg-white/90 backdrop-blur border-2 border-stone-200 rounded-xl p-4 mb-8 shadow-sm animate-fade-in">
                <h3 class="text-sm font-bold text-stone-800 mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 bg-yellow-400 rounded-full"></span> 
                    <span id="form-title">æ–°å¢æ”¯å‡º</span>
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-stone-500 block mb-1">èª°ä»˜çš„éŒ¢?</label>
                        <select id="input-payer" class="w-full bg-[#FAFAF9] border border-stone-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-stone-800">
                            <!-- Members injected -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 block mb-1">ä»˜äº†ä»€éº¼?</label>
                        <input id="input-desc" type="text" placeholder="ä¾‹å¦‚: åˆé¤, é–€ç¥¨..." class="w-full bg-[#FAFAF9] border border-stone-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-stone-800" />
                    </div>
                    <div>
                        <label class="text-xs text-stone-500 block mb-1">å¤šå°‘éŒ¢ (æ—¥å¹£)?</label>
                        <input id="input-amount" type="number" placeholder="0" class="w-full bg-[#FAFAF9] border border-stone-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-stone-800" />
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button id="btn-cancel-form" class="flex-1 py-2 text-stone-500 text-sm font-medium hover:bg-stone-100 rounded-lg">å–æ¶ˆ</button>
                        <button id="btn-save-expense" class="flex-1 py-2 bg-yellow-400 text-stone-900 text-sm font-bold rounded-lg shadow-sm hover:bg-yellow-500">ç¢ºå®š</button>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div class="space-y-6">
                <div>
                    <h3 class="serif text-lg font-bold text-[#4E342E] mb-3 border-b-2 border-yellow-200 inline-block">æ¶ˆè²»ç´€éŒ„</h3>
                    <div id="expense-list" class="space-y-3">
                        <!-- Expenses injected -->
                    </div>
                </div>

                <!-- Settlement -->
                <div id="settlement-section" class="pt-4 hidden">
                    <h3 class="serif text-lg font-bold text-stone-700 mb-3 border-b-2 border-teal-200 inline-block">çµç®—å»ºè­°</h3>
                    <div id="settlement-list" class="bg-white/90 backdrop-blur rounded-xl border border-stone-200 overflow-hidden">
                        <!-- Settlements injected -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="fixed bottom-0 left-0 right-0 z-50 bg-[#FEFCE8]/95 backdrop-blur border-t-2 border-[#78716C] flex justify-around pb-safe max-w-md mx-auto">
            <button id="tab-schedule" class="flex-1 py-3 flex flex-col items-center gap-1 transition-colors text-stone-800">
                <svg class="w-6 h-6 fill-yellow-400 stroke-stone-800" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-[10px] font-bold">è¡Œç¨‹è¡¨</span>
            </button>
            <button id="tab-wallet" class="flex-1 py-3 flex flex-col items-center gap-1 transition-colors text-stone-400">
                <svg class="w-6 h-6 stroke-current fill-none" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="text-[10px] font-bold">å…¬è²»åˆ†æ“”</span>
            </button>
        </div>

    </div>

    <!-- MAIN LOGIC -->
    <script type="module">
    import { GoogleGenAI } from "https://esm.run/@google/genai";

    // --- DATA ---
    const itineraryData = [
        {
            dateLabel: "1/10",
            dayOfWeek: "(å…­)",
            fullDate: "1/10 (é€±å…­) æŠµé”æ²–ç¹©",
            weatherIcon: "ğŸŒ¤ï¸",
            weatherTemp: "23Â°C æ™´æ™‚å¤šé›²",
            items: [
                { time: "08:10", mode: "é£›æ©Ÿ", title: "CI120 èµ·é£› (TPE -> OKA)", note: "10:40 æŠµé”æ²–ç¹©é‚£éœ¸æ©Ÿå ´", query: "é‚£éœ¸æ©Ÿå ´", travelTime: "é£›è¡Œç´„ 90åˆ†" },
                { time: "12:00", mode: "å…¬è»Š/è¨ˆç¨‹è»Š", title: "é£¯åº—å¯„æ”¾è¡Œæ / å‰å¾€å¸‚å€", note: "ä½å®¿ï¼šSeven Hotels Naha Miharanosatoã€‚å»ºè­°åˆ†å3å°è¨ˆç¨‹è»Šå…ˆæ”¾è¡Œæã€‚", query: "Seven Hotels Naha Miharanosato", travelTime: "ç´„ 20åˆ†" },
                { time: "13:00", mode: "æ­¥è¡Œ", title: "ç‰§å¿—å…¬è¨­å¸‚å ´ (åˆé¤)", note: "äº«ç”¨æµ·é®®ã€æ²–ç¹©æ–™ç†", query: "ç‰§å¿—å…¬è¨­å¸‚å ´", travelTime: "ç´„ 15åˆ†" },
                { time: "15:00", mode: "å–®è»Œ/è¨ˆç¨‹è»Š", title: "æ³¢ä¸Šå®® / æ³¢ä¹‹ä¸Šæµ·ç˜", note: "åƒæ‹œæ‡¸å´–ä¸Šçš„ç¥ç¤¾", query: "æ³¢ä¸Šå®®", travelTime: "ç´„ 15åˆ†" },
                { time: "17:00", mode: "å–®è»Œ/è¨ˆç¨‹è»Š", title: "é¦–é‡ŒåŸå…¬åœ’", note: "åƒè§€å¤–åœæˆ–æ¬£è³å¤•é™½", query: "é¦–é‡ŒåŸå…¬åœ’", travelTime: "ç´„ 30åˆ†" },
                { time: "19:30", mode: "æ­¥è¡Œ", title: "åœ‹éš›é€š (æ™šé¤/é€›è¡—)", note: "æ™šé¤å¾Œè¿”å›é£¯åº—", query: "åœ‹éš›é€š", travelTime: "ç´„ 20åˆ†" },
            ]
        },
        {
            dateLabel: "1/11",
            dayOfWeek: "(æ—¥)",
            fullDate: "1/11 (é€±æ—¥) å—éƒ¨è§€å…‰",
            weatherIcon: "â˜€ï¸",
            weatherTemp: "24Â°C æ™´æœ—èˆ’é©",
            items: [
                { time: "09:00", mode: "ç§Ÿè»Šè‡ªé§•", title: "ORIX å–è»Šï¼šæ—­æ©‹ç«™è¥¿åº—", note: "åœ°é»ï¼šORIX Asahibashi Station Westã€‚å»ºè­°æ­è¨ˆç¨‹è»Šå‰å¾€ï¼Œæ‰‹çºŒç´„ 1 å°æ™‚ã€‚", query: "ORIX Car Rental Asahibashi Station West", travelTime: "ç´„ 10åˆ†" },
                { time: "10:30", mode: "è‡ªé§•", title: "ç‰æ³‰æ´ / é˜ä¹³çŸ³", note: "æ²–ç¹©ä¸–ç•Œæ–‡åŒ–ç‹åœ‹", query: "æ²–ç¹©ä¸–ç•Œæ–‡åŒ–ç‹åœ‹ ç‰æ³‰æ´", travelTime: "ç´„ 30åˆ†" },
                { time: "13:00", mode: "è‡ªé§•", title: "ç€¨é•·å³¶ (å¹¸ç¦é¬†é¤…)", note: "åˆé¤/ä¸‹åˆèŒ¶ã€‚å‡æ—¥äººå¤šï¼Œå»ºè­°ä¸€åˆ°å…ˆæŠ½è™Ÿç¢¼ç‰Œã€‚", query: "ç€¨é•·å³¶ Umikaji Terrace", travelTime: "ç´„ 30åˆ†" },
                { time: "16:00", mode: "è‡ªé§•", title: "Aeon Mall Rycom", note: "å¯¶å¯å¤¢ä¸­å¿ƒã€Montbellã€è¶…å¸‚è£œè²¨", query: "Aeon Mall Okinawa Rycom", travelTime: "ç´„ 40åˆ†" },
            ]
        },
        {
            dateLabel: "1/12",
            dayOfWeek: "(ä¸€)",
            fullDate: "1/12 (é€±ä¸€) ä¸­éƒ¨ç©æ¨‚",
            weatherIcon: "â˜ï¸",
            weatherTemp: "22Â°C é™°å¤©å¾®é¢¨",
            items: [
                { time: "09:30", mode: "ç§Ÿè»Šè‡ªé§•", title: "æ°´ä¸Šæ´»å‹• or å¡ä¸è»Š", note: "åœ°é»ï¼šæ©ç´æ‘æˆ–åŒ—è°·å€åŸŸ", query: "æ©ç´æ‘", travelTime: "ç´„ 60åˆ†" },
                { time: "12:30", mode: "è‡ªé§•", title: "ç¾åœ‹æ‘ (American Village)", note: "åˆé¤ã€æ‹ç…§ã€æµ·æ¿±æ­¥é“", query: "ç¾åœ‹æ‘", travelTime: "ç´„ 30åˆ†" },
                { time: "17:30", mode: "ç§Ÿè»Šè‡ªé§•", title: "ORIX é‚„è»Šï¼šç¾æ¦®æ©‹ç«™åº—", note: "åœ°é»ï¼šORIX Miebashi Stationã€‚é‚„è»Šå‰è«‹è¨˜å¾—åŠ æ»¿æ²¹ã€‚", query: "ORIX Rent-a-car Miebashi Station", travelTime: "ç´„ 40åˆ†" },
                { time: "18:30", mode: "æ­¥è¡Œ", title: "å¸‚å€é€›è¡— / é£¯åº—ä¼‘æ¯", note: "ç¾æ¦®æ©‹ç«™é›¢åœ‹éš›é€šå¾ˆè¿‘ï¼Œé‚„è»Šå¾Œç§»å‹•æ–¹ä¾¿ã€‚", query: "ç¾æ¦®æ©‹ç«™", travelTime: "ç´„ 10åˆ†" },
                { time: "19:30", mode: "æ­¥è¡Œ", title: "æ™šé¤ï¼šç‡’è‚‰å·¥æˆ¿ åœ˜", note: "å¾ç¾æ¦®æ©‹ç«™æ­¥è¡Œå‰å¾€é¤å»³ç›¸å°ä¾¿åˆ©ã€‚", query: "ç‡’è‚‰å·¥æˆ¿ åœ˜ é‚£éœ¸", travelTime: "ç´„ 10åˆ†" },
            ]
        },
        {
            dateLabel: "1/13",
            dayOfWeek: "(äºŒ)",
            fullDate: "1/13 (é€±äºŒ) åŒ—éƒ¨åŒ…è»Š",
            weatherIcon: "â˜€ï¸",
            weatherTemp: "25Â°C é™½å…‰æ™®ç…§",
            items: [
                { time: "09:00", mode: "åŒ…è»Š", title: "åŒ…è»Šå‡ºç™¼å¾€åŒ—éƒ¨", note: "9äººåŒ…è»Šä¸€æ—¥éŠ", query: "é‚£éœ¸å¸‚", travelTime: "å‡ºç™¼" },
                { time: "11:00", mode: "åŒ…è»Š", title: "å¤å®‡åˆ©å³¶ / è¦è¦é£¯", note: "å»ºè­°ææ—©æŠµé”é¿é–‹æ’éšŠäººæ½®", query: "å¤å®‡åˆ©å³¶è¦è¦é£¯", travelTime: "ç´„ 90åˆ†" },
                { time: "13:30", mode: "åŒ…è»Š", title: "ç¾éº—æµ·æ°´æ—é¤¨", note: "åœç•™ç´„ 3 å°æ™‚ (é»‘æ½®ä¹‹æµ·ã€æµ·è±šç§€)", query: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", travelTime: "ç´„ 30åˆ†" },
                { time: "18:00", mode: "åŒ…è»Š", title: "è¿”å›é‚£éœ¸å¸‚å€", note: "åŒ…è»ŠçµæŸ", query: "é‚£éœ¸å¸‚", travelTime: "ç´„ 120åˆ†" },
                { time: "19:00", mode: "æ­¥è¡Œ", title: "æ™šé¤ï¼šé³¥è²´æ— (Torikizoku)", note: "ç¾æ¦®æ©‹åº— æˆ– æ¾å±±åº—ã€‚9äººå»ºè­°åˆ†æ‹† 2-3 æ¡Œï¼Œéœ€ç¾å ´å€™ä½ã€‚", query: "é³¥è²´æ— æ²–ç¹©", travelTime: "ç´„ 15åˆ†" },
            ]
        },
        {
            dateLabel: "1/14",
            dayOfWeek: "(ä¸‰)",
            fullDate: "1/14 (é€±ä¸‰) è³é¯¨èˆ‡è¿”ç¨‹",
            weatherIcon: "ğŸŒ¦ï¸",
            weatherTemp: "20Â°C å°é›¨è½‰é™°",
            items: [
                { time: "07:20", mode: "å…¬å…±äº¤é€š", title: "é€€æˆ¿ & è¡Œæå¯„æ”¾", note: "âš ï¸ è³é¯¨èˆ¹ç¦å¸¶è¡Œæç®±ã€‚è«‹å°‡è¡Œæå¸¶è‡³ ç‰§å¿—ç«™ æˆ– Saion Square ç½®ç‰©æ«ƒã€‚", query: "Saion Square Okinawa", travelTime: "ç´„ 15åˆ†" },
                { time: "07:55", mode: "æ­¥è¡Œ", title: "è³é¯¨é›†åˆ", note: "Family Mart (Saion Square) é›†åˆã€‚è«‹æº–æ™‚æŠµé”ã€‚", query: "Family Mart Saion Square", travelTime: "ç´„ 10åˆ†" },
                { time: "08:30", mode: "èˆ¹é‹", title: "å‡ºæµ·è³é¯¨", note: "äº«å—å‡ºæµ·æ¨‚è¶£", query: "é‚£éœ¸ æ³Šæ¸¯", travelTime: "ç´„ 15åˆ†" },
                { time: "12:30", mode: "æ­¥è¡Œ", title: "å…¨å“¡æœƒåˆ / åˆé¤", note: "è³é¯¨çµæŸï¼Œå…¨å“¡é›†åˆç”¨é¤", query: "Saion Square", travelTime: "ç´„ 10åˆ†" },
                { time: "14:00", mode: "å–®è»Œ", title: "æœ€å¾Œè£œè²¨ / æ©Ÿå ´ç§»å‹•", note: "æ‹¿å–å¯„æ”¾è¡Œæï¼Œå‰å¾€æ©Ÿå ´", query: "é‚£éœ¸æ©Ÿå ´", travelTime: "ç´„ 30åˆ†" },
                { time: "~20:50", mode: "é£›æ©Ÿ", title: "CI123 è¿”å°", note: "æ»¿è¼‰è€Œæ­¸", query: "é‚£éœ¸æ©Ÿå ´", travelTime: "ç´„ 20åˆ†" },
            ]
        },
    ];

    const members = ["é˜¿å®", "å°ç¾", "å¤§å‰", "Lisa", "Mike", "Jason", "Tina", "Kevin", "Emily"];

    // --- STATE ---
    let state = {
        selectedDay: 0,
        activeTab: 'schedule', // 'schedule' | 'wallet'
        expenses: [],
        editingId: null,
        isGeneratingCover: false,
    };

    // --- RENDER HELPERS ---
    
    // Sticker Icons
    function getStickerIcon(mode) {
        let icon, bgClass, borderClass;
        if (mode.includes("é£›æ©Ÿ")) {
            icon = "âœˆï¸"; bgClass = "bg-sky-100"; borderClass = "border-2 border-white ring-2 ring-sky-200";
        } else if (mode.includes("è‡ªé§•") || mode.includes("ç§Ÿè»Š") || mode.includes("åŒ…è»Š")) {
            icon = "ğŸš—"; bgClass = "bg-orange-100"; borderClass = "border-2 border-white ring-2 ring-orange-200";
        } else if (mode.includes("è¨ˆç¨‹è»Š")) {
            icon = "ğŸš•"; bgClass = "bg-yellow-100"; borderClass = "border-2 border-white ring-2 ring-yellow-200";
        } else if (mode.includes("å–®è»Œ") || mode.includes("å…¬è»Š") || mode.includes("å…¬å…±")) {
            icon = "ğŸš"; bgClass = "bg-indigo-100"; borderClass = "border-2 border-white ring-2 ring-indigo-200";
        } else if (mode.includes("èˆ¹")) {
            icon = "ğŸ›¥ï¸"; bgClass = "bg-blue-100"; borderClass = "border-2 border-white ring-2 ring-blue-200";
        } else {
            icon = "ğŸ‘£"; bgClass = "bg-emerald-100"; borderClass = "border-2 border-white ring-2 ring-emerald-200";
        }
        return `
        <div class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg transform -rotate-6 hover:rotate-6 transition-transform ${bgClass} ${borderClass}">
            <span class="text-2xl drop-shadow-sm">${icon}</span>
        </div>`;
    }

    // Render Dates
    function renderDates() {
        const container = document.getElementById('date-scroll');
        container.innerHTML = itineraryData.map((day, idx) => `
            <button onclick="window.selectDay(${idx})" class="flex-shrink-0 snap-start flex flex-col items-center justify-center w-16 h-20 py-2 rounded-2xl border-2 transition-all duration-300 ${state.selectedDay === idx ? 'bg-yellow-400 text-stone-900 border-white shadow-lg -translate-y-1 scale-105' : 'bg-white/80 text-stone-500 border-white shadow-sm hover:bg-white'}">
                <span class="text-sm font-black">${day.dateLabel}</span>
                <span class="text-xs font-medium mb-1">${day.dayOfWeek}</span>
                <span class="text-xs opacity-70 scale-75">${day.weatherIcon}</span>
            </button>
        `).join('');
    }

    // Render Itinerary List
    function renderItinerary() {
        const day = itineraryData[state.selectedDay];
        document.getElementById('day-title').textContent = day.fullDate;
        document.getElementById('day-weather-icon').textContent = day.weatherIcon;
        document.getElementById('day-weather-temp').textContent = day.weatherTemp;

        const container = document.getElementById('timeline-container');
        let html = '<div class="absolute left-[27px] top-6 bottom-6 w-0.5 border-l-2 border-dashed border-stone-300/60 z-0"></div>';

        html += day.items.map((item, idx) => `
            <div class="relative z-10 flex gap-4 group">
                ${(item.travelTime && idx > 0) ? `
                <div class="absolute left-[16px] -top-5 z-20">
                     <span class="text-[10px] font-bold text-stone-400 bg-[#FEFCE8] px-1.5 py-0.5 rounded border border-stone-200/50 whitespace-nowrap shadow-sm">
                       â¬‡ ${item.travelTime}
                     </span>
                </div>` : ''}

                <div class="flex-shrink-0 pt-1">
                    ${getStickerIcon(item.mode)}
                </div>

                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.query + " æ²–ç¹©")}" target="_blank" class="flex-grow bg-white/90 backdrop-blur rounded-2xl p-4 border-2 border-white shadow-md active:scale-[0.98] transition-all relative overflow-hidden group-hover:border-yellow-200 group-hover:shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-black text-stone-600 bg-yellow-100 px-2 py-0.5 rounded-md tracking-wide shadow-sm">${item.time}</span>
                        <span class="text-[10px] text-stone-400 font-bold uppercase tracking-wider">${item.mode}</span>
                    </div>
                    <h3 class="text-base font-bold text-stone-800 mb-1 leading-tight group-hover:text-amber-700 transition-colors flex items-center gap-1">${item.title}</h3>
                    <p class="text-sm text-stone-500 leading-relaxed font-normal">${item.note}</p>
                    <div class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         <div class="bg-green-100 rounded-full p-1.5 text-green-600 shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                         </div>
                    </div>
                </a>
            </div>
        `).join('');

        container.innerHTML = html;
    }

    // Render Wallet
    function renderWallet() {
        // Members Options
        const select = document.getElementById('input-payer');
        // Only refill if empty to preserve selection
        if(select.children.length === 0) {
            select.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        // List
        const list = document.getElementById('expense-list');
        if (state.expenses.length === 0) {
            list.innerHTML = `<div class="text-center py-8 text-stone-400 text-sm bg-white/50 rounded-xl border border-dashed border-stone-300">é‚„æ²’æœ‰ç´€éŒ„ï¼Œé–‹å§‹è¨˜å¸³å§ï¼</div>`;
        } else {
            list.innerHTML = state.expenses.map(e => `
                <div class="bg-white/90 backdrop-blur rounded-xl p-3 border border-stone-200 flex justify-between items-center shadow-sm group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-xs font-bold text-stone-600 border border-stone-200">${e.payer.charAt(0)}</div>
                        <div>
                            <p class="font-bold text-stone-800 text-sm">${e.description}</p>
                            <p class="text-xs text-stone-500">${e.payer} ä»˜æ¬¾</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-mono font-bold text-stone-800">Â¥${e.amount.toLocaleString()}</span>
                        <div class="flex gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editExpense('${e.id}')" class="p-1.5 text-stone-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </button>
                            <button onclick="window.deleteExpense('${e.id}')" class="p-1.5 text-stone-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Stats
        const total = state.expenses.reduce((acc, curr) => acc + curr.amount, 0);
        const avg = members.length ? total / members.length : 0;
        document.getElementById('total-spent').textContent = `Â¥${total.toLocaleString()}`;
        document.getElementById('avg-spent').textContent = `(${members.length}äººå‡åˆ† Â¥${Math.round(avg).toLocaleString()})`;

        // Settlement
        const settlementDiv = document.getElementById('settlement-section');
        const settlementList = document.getElementById('settlement-list');
        
        if (state.expenses.length > 0) {
            settlementDiv.classList.remove('hidden');
            const plans = calculateSettlement(total, avg);
            settlementList.innerHTML = plans.map((s, idx) => `
                <div class="p-4 flex items-center justify-between ${idx !== plans.length - 1 ? 'border-b border-stone-100' : ''}">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="font-bold text-red-500">${s.from}</span>
                        <span class="text-stone-400">â”</span>
                        <span class="font-bold text-green-600">${s.to}</span>
                    </div>
                    <span class="font-mono font-bold text-stone-800">Â¥${Math.round(s.amount).toLocaleString()}</span>
                </div>
            `).join('');
        } else {
            settlementDiv.classList.add('hidden');
        }
    }

    function calculateSettlement(total, avg) {
        let balances = {};
        members.forEach(m => balances[m] = -avg);
        state.expenses.forEach(e => balances[e.payer] += e.amount);

        let debtors = [];
        let creditors = [];
        Object.entries(balances).forEach(([name, amount]) => {
            if (amount < -0.01) debtors.push({name, amount});
            if (amount > 0.01) creditors.push({name, amount});
        });

        debtors.sort((a,b) => a.amount - b.amount);
        creditors.sort((a,b) => b.amount - a.amount);

        let result = [];
        let i=0, j=0;
        while(i < debtors.length && j < creditors.length) {
            let d = debtors[i];
            let c = creditors[j];
            let amount = Math.min(Math.abs(d.amount), c.amount);
            result.push({from: d.name, to: c.name, amount});
            d.amount += amount;
            c.amount -= amount;
            if(Math.abs(d.amount) < 0.01) i++;
            if(c.amount < 0.01) j++;
        }
        return result;
    }

    // Toggle Tabs
    function setTab(tab) {
        state.activeTab = tab;
        const scheduleView = document.getElementById('view-schedule');
        const walletView = document.getElementById('view-wallet');
        const tabSchedule = document.getElementById('tab-schedule');
        const tabWallet = document.getElementById('tab-wallet');
        const scheduleIcon = tabSchedule.querySelector('svg');
        const walletIcon = tabWallet.querySelector('svg');

        if (tab === 'schedule') {
            scheduleView.classList.remove('hidden');
            walletView.classList.add('hidden');
            
            tabSchedule.classList.replace('text-stone-400', 'text-stone-800');
            scheduleIcon.classList.replace('stroke-current', 'fill-yellow-400');
            scheduleIcon.classList.replace('fill-none', 'stroke-stone-800');

            tabWallet.classList.replace('text-stone-800', 'text-stone-400');
            walletIcon.classList.replace('fill-yellow-400', 'stroke-current');
            walletIcon.classList.replace('stroke-stone-800', 'fill-none');
        } else {
            scheduleView.classList.add('hidden');
            walletView.classList.remove('hidden');
            renderWallet();

            tabWallet.classList.replace('text-stone-400', 'text-stone-800');
            walletIcon.classList.replace('stroke-current', 'fill-yellow-400');
            walletIcon.classList.replace('fill-none', 'stroke-stone-800');

            tabSchedule.classList.replace('text-stone-800', 'text-stone-400');
            scheduleIcon.classList.replace('fill-yellow-400', 'stroke-current');
            scheduleIcon.classList.replace('stroke-stone-800', 'fill-none');
        }
    }

    // --- GLOBAL EXPORTS FOR HTML ONCLICK ---
    window.selectDay = (idx) => {
        state.selectedDay = idx;
        renderDates();
        renderItinerary();
    };

    window.switchTab = (tab) => setTab(tab);

    window.editExpense = (id) => {
        const exp = state.expenses.find(e => e.id === id);
        if(!exp) return;
        state.editingId = id;
        document.getElementById('input-payer').value = exp.payer;
        document.getElementById('input-desc').value = exp.description;
        document.getElementById('input-amount').value = exp.amount;
        document.getElementById('form-title').textContent = "ç·¨è¼¯æ”¯å‡º";
        document.getElementById('btn-show-form').classList.add('hidden');
        document.getElementById('expense-form').classList.remove('hidden');
        document.getElementById('btn-save-expense').textContent = "æ›´æ–°";
    };

    window.deleteExpense = (id) => {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            state.expenses = state.expenses.filter(e => e.id !== id);
            if(state.editingId === id) resetForm();
            renderWallet();
        }
    };

    // --- LOGIC INITIALIZATION ---
    
    // Tab Listeners
    document.getElementById('tab-schedule').onclick = () => setTab('schedule');
    document.getElementById('tab-wallet').onclick = () => setTab('wallet');

    // Expense Form Logic
    const resetForm = () => {
        state.editingId = null;
        document.getElementById('input-desc').value = "";
        document.getElementById('input-amount').value = "";
        document.getElementById('form-title').textContent = "æ–°å¢æ”¯å‡º";
        document.getElementById('btn-save-expense').textContent = "ç¢ºå®š";
        document.getElementById('expense-form').classList.add('hidden');
        document.getElementById('btn-show-form').classList.remove('hidden');
    };

    document.getElementById('btn-show-form').onclick = () => {
        resetForm();
        document.getElementById('btn-show-form').classList.add('hidden');
        document.getElementById('expense-form').classList.remove('hidden');
    };

    document.getElementById('btn-cancel-form').onclick = resetForm;

    document.getElementById('btn-save-expense').onclick = () => {
        const payer = document.getElementById('input-payer').value;
        const desc = document.getElementById('input-desc').value;
        const amount = parseFloat(document.getElementById('input-amount').value);

        if(!desc || isNaN(amount)) return;

        if (state.editingId) {
            state.expenses = state.expenses.map(e => e.id === state.editingId ? {...e, payer, description: desc, amount} : e);
        } else {
            state.expenses.unshift({
                id: Date.now().toString(),
                payer,
                description: desc,
                amount,
                date: new Date().toLocaleDateString()
            });
        }
        resetForm();
        renderWallet();
    };


    // --- AI LOGIC ---

    // Note: In a downloaded file, API Key must be handled.
    // For this demo, we assume the user has the key environment or uses the "window.aistudio" injection if running in AI Studio.
    // Since this is a standalone file request, I will check for process.env.API_KEY or prompt.
    
    const getAI = async () => {
       const win = window;
       let key = "";
       
       if (win.aistudio) {
          const hasKey = await win.aistudio.hasSelectedApiKey();
          if (!hasKey) {
             await win.aistudio.openSelectKey();
          }
          // The SDK in window.aistudio environment might inject key via process.env automatically
          // But if we are running "Vanilla" locally, we need the key.
       }
       
       // Fallback for local run
       if (typeof process !== 'undefined' && process.env && process.env.API_KEY) {
           key = process.env.API_KEY;
       }
       
       // In this specific single file export, we assume the environment handles it or user manually inputs it if not in AI Studio.
       // Creating the client:
       return new GoogleGenAI({ apiKey: key || 'YOUR_API_KEY_HERE_IF_LOCAL' }); 
    };

    // Header Image Generation
    document.getElementById('btn-generate-cover').onclick = async () => {
        const btn = document.getElementById('btn-generate-cover');
        const iconPaint = document.getElementById('icon-paint');
        const iconLoading = document.getElementById('icon-loading');
        
        btn.disabled = true;
        iconPaint.classList.add('hidden');
        iconLoading.classList.remove('hidden');

        try {
            const ai = await getAI();
            const prompt = "Cute hand-drawn Okinawa travel illustration, watercolor style, beige paper texture background, including Shisa, Hibiscus, Whale Shark, soft pastel colors, wide landscape aspect ratio, kawaii style.";
            
            const response = await ai.models.generateContent({
                model: 'gemini-3-pro-image-preview',
                contents: { parts: [{ text: prompt }] },
                config: { imageConfig: { imageSize: '1K', aspectRatio: '16:9' } }
            });

            let imgData = null;
            if(response.candidates?.[0]?.content?.parts) {
                for(const p of response.candidates[0].content.parts) {
                    if(p.inlineData) imgData = `data:image/png;base64,${p.inlineData.data}`;
                }
            }
            if(imgData) {
                document.getElementById('header-img').src = imgData;
            }
        } catch(e) {
            console.error(e);
            alert("ç„¡æ³•ç”Ÿæˆåœ–ç‰‡ (Check API Key)");
        } finally {
            btn.disabled = false;
            iconPaint.classList.remove('hidden');
            iconLoading.classList.add('hidden');
        }
    };

    // Chat AI
    document.getElementById('btn-ask-ai').onclick = async () => {
        const input = document.getElementById('input-ai');
        const question = input.value.trim();
        if(!question) return;

        const btn = document.getElementById('btn-ask-ai');
        const responseArea = document.getElementById('ai-response-area');
        const contentDiv = document.getElementById('ai-text-content');
        const sourcesDiv = document.getElementById('ai-sources');
        const inputArea = document.getElementById('ai-input-area');

        btn.textContent = "...";
        btn.disabled = true;

        try {
            const ai = await getAI();
            const model = "gemini-2.5-flash";
            const systemInstruction = "You are an expert travel guide for Okinawa. Reply in Traditional Chinese. Use Google Maps for locations.";
            
            const result = await ai.models.generateContent({
                model,
                contents: `User question: ${question}`,
                config: {
                    systemInstruction,
                    tools: [{ googleSearch: {} }, { googleMaps: {} }],
                }
            });

            const text = result.response.text();
            // Grounding
            const chunks = result.response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];

            // Render Markdown
            contentDiv.innerHTML = marked.parse(text);
            
            // Render Sources
            sourcesDiv.innerHTML = chunks.filter(c => c.web).map(c => 
                `<a href="${c.web.uri}" target="_blank" class="text-[10px] bg-stone-100 text-stone-500 px-2 py-1 rounded-full truncate max-w-[150px] block border border-stone-200">ğŸ”— ${c.web.title}</a>`
            ).join('');

            responseArea.classList.remove('hidden');
            inputArea.classList.add('hidden');

        } catch(e) {
            alert("AI Error: " + e.message);
        } finally {
            btn.textContent = "Go";
            btn.disabled = false;
        }
    };

    document.getElementById('btn-reset-ai').onclick = () => {
        document.getElementById('ai-response-area').classList.add('hidden');
        document.getElementById('ai-input-area').classList.remove('hidden');
        document.getElementById('input-ai').value = "";
    };

    document.getElementById('input-ai').onkeydown = (e) => {
        if(e.key === 'Enter') document.getElementById('btn-ask-ai').click();
    };

    // --- INIT ---
    renderDates();
    renderItinerary();
    </script>
</body>
</html>
